<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Basic Axes</title>
</head>

<style> /* set the CSS */

body { font: 12px Arial;}

path {
    stroke: black;
    stroke-width: 2;
    fill: none;
}

.result {
    stroke: red;
}

.axis path,
.axis line {
    fill: none;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

.deposit {
    fill: green;
    stroke-width:0
}

.debit {
    fill: red;
    stroke-width:0
}

</style>

<body>

<svg width="900" height="1500"></svg>

<script src="../lib/d3/d3.js"></script>
<!--<script src="../lib/d3-collection/d3-collection.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>-->

<script type="text/javascript">

    Array.prototype.flatMap = function(lambda) {
        return Array.prototype.concat.apply([], this.map(lambda));
    };

    var parseTime = d3.timeParse("%Y-%m-%d");

    var startDay = parseTime("2018-01-01");

    var deposits = [
        {"date": "2018-02-01", "value": 30},
        {"date": "2018-02-05", "value": 30},
        {"date": "2018-02-10", "value": 30},
        {"date": "2018-02-15", "value": 30},
        {"date": "2018-02-20", "value": -150},
        {"date": "2018-02-22", "value": -50},
        {"date": "2018-03-01", "value": 120},
        {"date": "2018-03-10", "value": 120},
        {"date": "2018-03-15", "value": 120}
    ];

    var prev = {"date": startDay, "value": 0};
    var balances = deposits.flatMap(d => {
        d.date = parseTime(d.date);
        var x = {"date": d.date, "value": prev.value};
        prev = {"date": d.date, "value": prev.value + d.value};
        return [x, prev];
    });

    console.log(deposits, balances);

    var svg = d3.select("svg")
        .attr("class", "axis");

    var width = +svg.attr("width");
    var middleWidth = width / 2;
    var height = +svg.attr("height");

    var margin = 25;
    var axisHeight = height - 2 * margin;

    var timeScale = createTimeScale(svg,
        new Date(2018, 0, 1),
        new Date(2018, 3, 1),
        axisHeight);
    var valueScale = createValueScale(svg);

    var oneDayHeight = timeScale(new Date(2000, 1, 2)) - timeScale(new Date(2000, 1, 1))
    console.log("One day height: " + oneDayHeight);

    var line = d3.line()
        .x(function(d) { return valueScale(d.value); })
        .y(function(d) { return timeScale(d.date); });

    // BALANCE
    svg.append("path")
        .attr("class", "result")
        .style("stroke-dasharray", ("2, 2"))
        .attr("d", line(balances))
        .attr("transform", "translate(" + middleWidth + ", " + margin + ")");

    // DEPOSITS
    svg.selectAll(".bar")
        .data(deposits)
        .enter()
        .append("rect")
        .attr("class", function(d) { if(d.value >= 0) { return "deposit"; } else { return "debit"; }; })
        .attr("x", function(d) { if(d.value >= 0) { return 0; } else { return -valueScale(Math.abs(d.value)); }; })
        .attr("width", function(d) { return valueScale(Math.abs(d.value)); })
        .attr("y", function(d) { return timeScale(d.date); })
        .attr("height", oneDayHeight - 1)
        .attr("transform", "translate(" + middleWidth + ", " + margin + ")");

    // svg.selectAll(".bar")
    //     .data(deposits)
    //     .enter()
    //     .append("text")
    //     .attr("x", width / 2 - 110)
    //     .attr("y", function(d) { return timeScale(d.date); })
    //     .text(function(d) { return "FV +" + d.value + ".000,00 zł"; })
    //     .attr("transform", "translate(" + middleWidth + ", " + margin + ")");

    // svg.selectAll(".bar")
    //     .data(debits)
    //     .enter()
    //     .append("rect")
    //     .attr("class", "debit")
    //     .attr("x", function(d) { return valueScale(-d.value); })
    //     .attr("width", function(d) { return valueScale(d.value); })
    //     .attr("y", function(d) { return timeScale(d.date); })
    //     .attr("height", oneDayHeight - 1)
    //     .attr("transform", "translate(" + middleWidth + ", " + margin + ")");

    // svg.selectAll(".bar")
    //     .data(debits)
    //     .enter()
    //     .append("text")
    //     .attr("x", 0)
    //     .attr("y", function(d) { return timeScale(d.date); })
    //     .text(function(d) { return "FV -" + d.value + ".000,00 zł"; })
    //     .attr("transform", "translate(" + 0 + ", " + margin + ")");

    svg.append("text")
        .attr("x", 10)
        .attr("y", 20)
        .text("Rentowność: 120.000,00 zł")
        .attr("transform", "translate(" + width / 2 + ", " + margin + ")");

    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function createTimeScale(svg, startDate, stopDate, height) {
        var timeScale = d3.scaleTime()
            .domain([startDate, stopDate])
            .range([0, height]);
        var timeAxis = d3.axisRight()
            .scale(timeScale)
            .ticks(10);
        svg.append("g")
            .attr("transform", "translate(" + middleWidth + ", " + margin + ")")
            .call(timeAxis);
        return timeScale;
    }

    function createValueScale(svg) {
        var valueScale = d3.scaleLinear()
            .domain([-1450, 1450])
            .range([-middleWidth, middleWidth]);
        var valueAxis = d3.axisTop()
            .scale(valueScale)
            .ticks(10);
        svg.append("g")
            .attr("transform", "translate(" + middleWidth + ", " + margin + ")")
            .call(valueAxis);
        return valueScale;
    }

</script>

</body>

</html>
